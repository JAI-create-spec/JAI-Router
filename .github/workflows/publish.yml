name: "Publish (LLM tier: ${{ matrix.llm_tier }})"

on:
  release:
    types: [created]
  workflow_dispatch:

jobs:
  publish:
    name: "Publish (LLM tier: ${{ matrix.llm_tier }})"
    runs-on: ubuntu-latest
    strategy:
      matrix:
        llm_tier: [free, paid]
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path:
            |
              ~/.gradle/caches
              ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/gradle/wrapper/**','**/gradle-wrapper.properties','**/*.gradle*') }}

      - name: Validate Gradle wrapper
        uses: gradle/wrapper-validation-action@v1

      - name: Grant execute permission for gradlew
        run:
          |
            chmod +x gradlew

      - name: Build project (assemble)
        run:
          |
            echo "Building for LLM tier: ${{ matrix.llm_tier }}"
            ./gradlew clean assemble --no-daemon -PllmTier=${{ matrix.llm_tier }}

      - name: Publish artifacts
        if: ${{ matrix.llm_tier == 'free' || (matrix.llm_tier == 'paid' && secrets.PUBLISH_PAID_TOKEN) }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PUBLISH_PAID_TOKEN: ${{ secrets.PUBLISH_PAID_TOKEN }}
        run:
          |
            if [ "${{ matrix.llm_tier }}" = "paid" ]; then
              echo "Publishing paid artifacts (using PUBLISH_PAID_TOKEN secret)"
              # Gradle logic should read -PpublishToken or similar to sign/publish paid artifacts.
              ./gradlew publish -PllmTier=paid -PpublishToken="$PUBLISH_PAID_TOKEN" --no-daemon
            else
              echo "Publishing free artifacts (using GITHUB_TOKEN)"
              ./gradlew publish -PllmTier=free --no-daemon
            fi

      - name: Notify skipped paid publish
        if: ${{ matrix.llm_tier == 'paid' && !secrets.PUBLISH_PAID_TOKEN }}
        run:
          |
            echo "Paid artifact publish skipped because PUBLISH_PAID_TOKEN secret is not set. To enable, add the secret in repository settings."
